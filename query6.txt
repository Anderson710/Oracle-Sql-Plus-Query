SET LINESIZE 120
SET PAGESIZE 40

ALTER SESSION SET NLS_DATE_FORMAT = 'DD-MM-YYYY';

COLUMN CAT_ID FORMAT A10
COLUMN CAT_NAME FORMAT A15
COLUMN POPULARITY FORMAT 999
COLUMN PREV_POPULARITY FORMAT 999
COLUMN DIFFERENCE FORMAT 999
COLUMN AVG_POPULARITY FORMAT 999

ACCEPT year char FORMAT A4 PROMPT 'Enter the year: '

TTITLE CENTER 'POPULARITY CATEGORY PURCHASES BY CUSTOMERS'
BREAK ON TTITLE SKIP 2;

CREATE OR REPLACE VIEW YEAR AS
	SELECT ORD_ID, EXTRACT (YEAR FROM ORD_DATE) AS YEARS
	FROM MENU_ORDER
	GROUP BY ORD_ID, EXTRACT (YEAR FROM ORD_DATE) 
	ORDER BY EXTRACT (YEAR FROM ORD_DATE) ASC;

WITH DIS_TABLE (
 	CAT_ID, 
	CAT_NAME, 
	POPULARITY,
	PREV_POPULARITY,
	AVG_POPULARITY
)

AS(
	SELECT 	
		CA.CAT_ID, 
		CA.CAT_NAME, 
		COUNT(MO.CUST_ID) AS POPULARITY,
		LAG(COUNT(MO.CUST_ID)) OVER (PARTITION BY CA.CAT_ID ORDER BY Y.YEARS) PREV_POPULARITY,
		ROUND(AVG(COUNT(MO.CUST_ID)) OVER (PARTITION BY CA.CAT_ID),0)AVG_POPULARITY
		
	FROM 
		CATEGORY CA
		JOIN MENU M ON (CA.CAT_ID = M.CAT_ID)
		JOIN ORDER_ITEM OI ON (M.ITEM_ID = OI.ITEM_ID)
		JOIN MENU_ORDER MO ON (OI.ORD_ID = MO.ORD_ID)
		JOIN CUSTOMER CU ON (MO.CUST_ID = CU.CUST_ID)
		JOIN YEAR Y ON (MO.ORD_ID = Y.ORD_ID)

	WHERE Y.YEARS = '&year'
	GROUP BY CA.CAT_ID, CA.CAT_NAME, Y.YEARS
	ORDER BY CA.CAT_ID
)

SELECT 
	CAT_ID, 
	CAT_NAME, 
	POPULARITY,
	PREV_POPULARITY,
	CASE 
    	 WHEN PREV_POPULARITY IS NULL THEN POPULARITY
  	ELSE
    	 POPULARITY - PREV_POPULARITY
  	END DIFFERENCE,
	AVG_POPULARITY

FROM DIS_TABLE;

CLEAR COLUMNS
CLEAR BREAKS
CLEAR COMPUTES

TTITLE OFF